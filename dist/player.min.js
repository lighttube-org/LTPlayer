/* LTPlayer v1.5
 * https://github.com/kuylar/LTPlayer
 */
class Player{constructor(e,t){if(this.player=document.querySelector(e),this.player.removeAttribute("controls"),this.info=t,this.playerType="html5",this.controlsHideTime=Number.MAX_SAFE_INTEGER,!t)throw Error("info must be provided while constructing a new Player instance!");if(t.chapters&&0!==t.chapters.length||(t.chapters=[{from:0,to:100,name:""}]),t.storyboard&&"yt_l1"===t.storyboard.type&&(this.storyboardImage=new Image,this.storyboardImage.src=t.storyboard.src),this.root=this.buildPlayerElement({author:t.author,title:t.title,playButtonHtml:t.buttons.play,pauseButtonHtml:t.buttons.pause,muteButtonHtml:t.buttons.volumeMedium,settingsButtonHtml:t.buttons.settings,fullscreenButtonHtml:t.buttons.fullscreen,minimizeButtonHtml:t.buttons.minimize,chapters:t.chapters,segments:t.segments,endscreen:t.endscreen,loading:t.loading}),this.player.parentElement.insertBefore(this.root,this.player),this.root.insertBefore(this.player,this.root.firstElementChild),t.hlsManifest&&Hls.isSupported()&&(this.playerType="hls.js",this.hlsjs=new Hls,this.hlsjs.on(Hls.Events.MANIFEST_PARSED,(e,t)=>{console.log(`[HLS.JS] Manifest parsed with ${t.levels.length} quality levels`),this.updateSelects()}),this.hlsjs.on(Hls.Events.LEVEL_SWITCHED,(e,{level:t})=>{console.log(`[HLS.JS] Switched to the quality level ${this.hlsjs.levels[t].height}p (${t})`),this.updateSelects()}),this.hlsjs.loadSource(t.hlsManifest),this.hlsjs.attachMedia(this.player)),this.info.rememberVolume){let s=window.localStorage.getItem("ltplayer.volume");null!=s&&(this.player.volume=Number(s))}this.assignEvents(),this.updateButtons(),this.updateSelects(),null!=t.endscreen&&this.buildEndscreen()}buildPlayerElement(e){let t=[],s=document.createElement("DIV");s.setAttribute("class","ltp-root");let l=document.createElement("DIV");l.setAttribute("class","ltp-gradient-top"),s.appendChild(l);let n=document.createElement("DIV");n.setAttribute("class","ltp-endscreen"),n.style.display="none",s.appendChild(n);let i=document.createElement("DIV");i.setAttribute("class","ltp-title");let r=document.createElement("A");r.setAttribute("class","ltp-title__icon"),r.setAttribute("style",`background-image: url('${e.author?.icon}');background-size:contain;`),r.setAttribute("href",e.author?.href),r.setAttribute("title",e.author?.title),i.appendChild(r);let a=document.createElement("SPAN");a.setAttribute("class","ltp-title__text"),a.innerHTML=e.title,i.appendChild(a),s.appendChild(i);let o=document.createElement("DIV");o.setAttribute("class","ltp-gradient-bottom"),s.appendChild(o);let h=document.createElement("DIV");h.setAttribute("class","ltp-loading"),h.innerHTML=e.loading,s.appendChild(h);let u=document.createElement("DIV");for(let p of(u.setAttribute("class","ltp-progress-container"),e.chapters)){let d=document.createElement("DIV");d.setAttribute("class","ltp-progress"),d.setAttribute("title",p.name),d.style.width=p.to-p.from+"%";let c=document.createElement("DIV");c.setAttribute("class","ltp-progress__buffered"),d.appendChild(c);let m=document.createElement("DIV");m.setAttribute("class","ltp-progress__played"),d.appendChild(m),u.appendChild(d),t.push({name:p.name,to:p.to,from:p.from,background:d,buffered:c,played:m})}this.buildSegments(e.segments||[],t),s.appendChild(u);let y=document.createElement("DIV");y.setAttribute("class","ltp-controls");let b=document.createElement("DIV");b.setAttribute("class","ltp-controls-button"),b.innerHTML=e.playButtonHtml,y.appendChild(b);let f=document.createElement("DIV");f.setAttribute("class","ltp-controls-volume-icon");let g;g=this.player.muted?this.info.buttons.volumeMute:this.player.volume>.7?this.info.buttons.volumeHigh:this.player.volume<.3?this.info.buttons.volumeLow:this.info.buttons.volumeMedium,f.innerHTML=g,y.appendChild(f);let $=document.createElement("DIV");$.setAttribute("class","ltp-controls-volume");let E=document.createElement("DIV");E.setAttribute("class","ltp-controls-volume-bar");let v=document.createElement("DIV");v.setAttribute("class","ltp-controls-volume-value"),E.appendChild(v),$.appendChild(E),y.appendChild($);let C=document.createElement("DIV");C.setAttribute("class","ltp-controls-timestamp"),C.innerHTML="--:-- / --:--",y.appendChild(C);let T=document.createElement("DIV");T.setAttribute("class","ltp-controls-divider"),y.appendChild(T);let k=document.createElement("DIV");k.setAttribute("class","ltp-controls-button"),k.innerHTML=e.settingsButtonHtml,y.appendChild(k);let M=document.createElement("DIV");M.setAttribute("class","ltp-controls-button"),M.innerHTML=e.fullscreenButtonHtml,y.appendChild(M),s.appendChild(y);let S=document.createElement("DIV");S.classList.add("ltp-storyboard-container");let A=document.createElement("CANVAS");A.classList.add("ltp-storyboard-image"),S.appendChild(A);let L=document.createElement("DIV");L.classList.add("ltp-storyboard-text"),S.appendChild(L),s.appendChild(S);let _=document.createElement("DIV");_.setAttribute("class","ltp-menu");let I=document.createElement("LABEL");I.setAttribute("class","ltp-menuitem");let B=document.createElement("SPAN");B.innerHTML="Playback speed",I.appendChild(B);let w=document.createElement("SELECT");w.appendChild(this.createMenuOption("0.25",".25")),w.appendChild(this.createMenuOption("0.50",".5")),w.appendChild(this.createMenuOption("0.75",".75")),w.appendChild(this.createMenuOption("Normal","1",!0)),w.appendChild(this.createMenuOption("1.25","1.25")),w.appendChild(this.createMenuOption("1.50","1.5")),w.appendChild(this.createMenuOption("1.75","1.75")),w.appendChild(this.createMenuOption("2","2")),I.appendChild(w),_.appendChild(I);let H=document.createElement("LABEL");H.setAttribute("class","ltp-menuitem");let x=document.createElement("SPAN");x.innerHTML="Subtitles/CC",H.appendChild(x);let V=document.createElement("SELECT");H.appendChild(V),_.appendChild(H);let D=document.createElement("LABEL");D.setAttribute("class","ltp-menuitem");let O=document.createElement("SPAN");O.innerHTML="Quality",D.appendChild(O);let j=document.createElement("SELECT");D.appendChild(j),_.appendChild(D);let P=document.createElement("LABEL");P.setAttribute("class","ltp-menuitem");let N=document.createElement("SPAN");N.innerHTML="Audio track",P.appendChild(N);let q=document.createElement("SELECT");P.appendChild(q),_.appendChild(P),s.appendChild(_);let F=document.createElement("DIV");return F.classList.add("ltp-skip"),s.appendChild(F),D.style.display="none",H.style.display="none",P.style.display="none",_.style.display="none",this.elements={root:s,endscreenContainer:n,authorIcon:r,videoTitle:a,timestamp:C,volumeBar:v,progressBarSections:t,buttons:{play:b,mute:f,settings:k,fullscreen:M,skip:F},menus:{menu:_,speed:w,quality:j,subtitles:V,audioTracks:q},storyboard:{container:S,image:A,context:A.getContext("2d"),text:L},loading:h},s}createMenuOption(e,t,s){let l=document.createElement("OPTION");return l.innerHTML=e,l.setAttribute("value",t),s&&l.setAttribute("selected","selected"),l}assignEvents(){this.elements.buttons.play.onclick=()=>{this.player.paused?this.player.play():this.player.pause()},this.player.onpause=()=>{this.updateButtons()},this.player.onplay=()=>{this.updateButtons()},this.player.onclick=()=>{this.player.paused?this.player.play():this.player.pause()},this.player.ondblclick=()=>{window.fullScreen?document.exitFullscreen().then(()=>{this.updateButtons()}).catch(()=>{this.updateButtons()}):this.root.requestFullscreen({navigationUI:"hide"}).then(()=>{this.updateButtons()}).catch(()=>{this.updateButtons()})},this.addMouseMoveEvents(this.elements.root),this.elements.buttons.mute.onclick=()=>{this.player.muted=!this.player.muted,this.updateButtons()},this.elements.buttons.fullscreen.onclick=()=>{(window.fullScreen?document.exitFullscreen():this.root.requestFullscreen({navigationUI:"hide"})).then(()=>{this.updateButtons()}).catch(()=>{this.updateButtons()})},this.player.ontimeupdate=()=>{Date.now()>this.controlsHideTime&&!this.root.classList.contains("controls-hidden")?this.root.classList.add("controls-hidden"):Date.now()<this.controlsHideTime&&this.root.classList.contains("controls-hidden")&&this.root.classList.remove("controls-hidden"),this.resizeProgressBar("played",this.player.currentTime/this.player.duration*100),this.checkSegments()},this.player.onvolumechange=()=>{this.elements.volumeBar.style.width=100*this.player.volume+"%";let e;if(e=this.player.muted?this.info.buttons.volumeMute:this.player.volume>.7?this.info.buttons.volumeHigh:this.player.volume<.3?this.info.buttons.volumeLow:this.info.buttons.volumeMedium,this.elements.buttons.mute.innerHTML=e,this.info.rememberVolume)try{window.localStorage.setItem("ltplayer.volume",this.player.volume)}catch(t){}},this.elements.volumeBar.parentElement.parentElement.onclick=e=>{this.player.volume=this.percentageFromMouseOverEvent(e,this.elements.volumeBar.parentElement)},this.elements.progressBarSections[0].background.parentElement.onclick=e=>{this.player.currentTime=this.percentageFromMouseOverEvent(e,this.elements.progressBarSections[0].background.parentElement)*this.player.duration},this.elements.progressBarSections[0].background.parentElement.onmousemove=e=>{this.updateStoryboard(this.percentageFromMouseOverEvent(e,this.elements.progressBarSections[0].background.parentElement))},this.elements.progressBarSections[0].background.parentElement.onmouseenter=()=>{this.updateStoryboard(!0)},this.elements.progressBarSections[0].background.parentElement.onmouseleave=()=>{this.updateStoryboard(!1)},this.elements.buttons.settings.onclick=()=>{"none"===this.elements.menus.menu.style.display?this.elements.menus.menu.style.display="flex":this.elements.menus.menu.style.display="none"},this.elements.menus.speed.onchange=()=>{this.player.playbackRate=parseFloat(this.elements.menus.speed.value),this.elements.menus.menu.style.display="none"},this.elements.menus.quality.onchange=()=>{switch(this.playerType){case"html5":let e=this.player.currentTime;this.player.src=this.elements.menus.quality.value,this.player.currentTime=e;break;case"hls.js":let t=this.elements.menus.quality.value;this.hlsjs.nextLevel=parseInt(t);break;default:console.error(`Unknown player type ${this.playerType}`)}this.elements.menus.menu.style.display="none"},this.elements.menus.audioTracks.onchange=()=>{"hls.js"===this.playerType?this.hlsjs.audioTrack=parseInt(this.elements.menus.audioTracks.value):console.error(`Unknown player type ${this.playerType}`),this.elements.menus.menu.style.display="none"},this.elements.menus.subtitles.onchange=()=>{for(let e=0;e<this.player.textTracks.length;e++)this.player.textTracks[e].mode="hidden";if("null"===this.elements.menus.subtitles.value)return;let t=Array.from(this.player.textTracks).filter(e=>e.label===this.elements.menus.subtitles.value)[0];t.mode="showing",this.elements.menus.menu.style.display="none"},window.onkeydown=e=>{this.elements.root.contains(e.target)&&(!(!e.ctrlKey&&!e.altKey&&!e.metaKey&&!e.shiftKey&&this.handleHotkey(e.key))||e.preventDefault())},setInterval(()=>{this.player.buffered.length>0&&this.resizeProgressBar("buffered",this.player.buffered.end(this.player.buffered.length-1)/this.player.duration*100,!0),this.elements.timestamp.innerText=`${this.timestampFromMs(this.player.currentTime)} / ${this.timestampFromMs(this.player.duration)}`,this.updateLoading()},100)}addMouseMoveEvents(e){for(let t of Array.from(e.children))this.addMouseMoveEvents(t);e.addEventListener("mousemove",()=>{this.root.classList.remove("controls-hidden"),this.controlsHideTime=Date.now()+5e3})}updateButtons(){this.elements.buttons.play.innerHTML=this.player.paused?this.info.buttons.play:this.info.buttons.pause,this.elements.buttons.fullscreen.innerHTML=window.fullScreen?this.info.buttons.minimize:this.info.buttons.fullscreen}percentageFromMouseOverEvent(e,t){return t||(t=e.target),this.remapNumber(e.clientX,t.getBoundingClientRect().left,t.getBoundingClientRect().left+t.clientWidth-1,0,1)}timestampFromMs(e){let t=e,s=Math.floor(t/3600);t%=3600;let l=Math.floor(t/60).toString().padStart(2,"0");return t=Math.floor(t%60).toString().padStart(2,"0"),s>0?`${s}:${l}:${t}`:`${l}:${t}`.replaceAll("NaN","--")}resizeProgressBar(e,t){let s=!1;for(let l of this.elements.progressBarSections)s?l[e].style.width="0%":0<=t&&t<=0+l.to?(l[e].style.width=this.remapNumber(t,l.from,l.to,0,100)+"%",s=!0):l[e].style.width="100%"}remapNumber(e,t,s,l,n){return l+(n-l)*(e-t)/(s-t)}updateSelects(){switch(this.playerType){case"html5":let e=Array.from(this.player.children),t=e.filter(e=>"SOURCE"===e.tagName),s=Array.from(this.player.textTracks).filter(e=>"vtt"===e.groupId);if(t.length>1){let l=!1,n=[];for(let i of t){let r=i.getAttribute("label"),a=i.getAttribute("src"),o=a===this.player.currentSrc;o&&(l=!0),n.push(this.createMenuOption(r,a,o))}for(let h of(l||n[0].setAttribute("selected","selected"),n))this.elements.menus.quality.appendChild(h);this.elements.menus.quality.parentElement.style.display="flex"}if(s.length>0){let u=!1,p=[];for(let d of(p.push(this.createMenuOption("Off",null)),s)){let c=d.label,m="showing"===d.mode;m&&(u=!0),p.push(this.createMenuOption(c,c,m))}for(let y of(u||p[0].setAttribute("selected","selected"),p))this.elements.menus.subtitles.appendChild(y);this.elements.menus.subtitles.parentElement.style.display="flex"}break;case"hls.js":let b=[],f=this.hlsjs.levels.filter(e=>e.videoCodec.startsWith("avc1")),g=this.hlsjs.currentLevel>0?this.hlsjs.levels[this.hlsjs.currentLevel].height:void 0,$=[];for(let E of(this.hlsjs.autoLevelEnabled?$.push(this.createMenuOption(`Auto (${g}p)`,-1,!0)):$.push(this.createMenuOption("Auto",-1)),f))b.includes(E.height)||(b.push(E.height),$.push(this.createMenuOption(E.height+"p",this.hlsjs.levels.indexOf(E),E.height===g&&!this.hlsjs.autoLevelEnabled)));for(;this.elements.menus.quality.firstElementChild;)this.elements.menus.quality.children[0].remove();for(let v of $)this.elements.menus.quality.appendChild(v);if(this.elements.menus.quality.parentElement.style.display="flex",this.hlsjs.audioTracks.length>1){let C=[];for(let T of this.hlsjs.audioTracks)C.push(this.createMenuOption(T.name,T.id,this.hlsjs.audioTrack===T.id));for(;this.elements.menus.audioTracks.firstElementChild;)this.elements.menus.audioTracks.children[0].remove();for(let k of C)this.elements.menus.audioTracks.appendChild(k);this.elements.menus.audioTracks.parentElement.style.display="flex"}let M=Array.from(this.player.textTracks).filter(e=>"vtt"===e.groupId);if(console.log(M),M.length>0){let S=!1,A=[];for(let L of(A.push(this.createMenuOption("Off",null)),M)){let _=L.label,I="showing"===L.mode;I&&(S=!0),A.push(this.createMenuOption(_,_,I))}for(S||A[0].setAttribute("selected","selected");this.elements.menus.subtitles.firstElementChild;)this.elements.menus.subtitles.children[0].remove();for(let B of A)this.elements.menus.subtitles.appendChild(B);this.elements.menus.subtitles.parentElement.style.display="flex"}break;default:console.error(`Unknown player type: ${this.playerType}`)}}updateStoryboard(e){if("boolean"==typeof e)e?this.elements.storyboard.container.style.display="flex":this.elements.storyboard.container.style.display="none";else{let t=e*this.player.duration;this.elements.storyboard.text.innerText=this.timestampFromMs(t),e<.5?(this.elements.storyboard.container.style.left=`calc(${Math.max(0,100*e)}% - 87.5px)`,this.elements.storyboard.container.style.right="unset"):(this.elements.storyboard.container.style.right=`calc(${Math.max(0,(1-e)*100)}% - 87.5px)`,this.elements.storyboard.container.style.left="unset"),null==this.storyboardImage?this.elements.storyboard.image.style.display="none":this.elements.storyboard.context.drawImage(this.storyboardImage,48*Math.floor((10*e-Math.trunc(10*e))*10),27*Math.floor(10*e),48,27,0,0,this.elements.storyboard.image.width,this.elements.storyboard.image.height)}}handleHotkey(e){switch(e.toLowerCase()){case" ":case"k":return this.player.paused?this.player.play():this.player.pause(),!0;case"m":return this.elements.buttons.mute.click(),!0;case"j":case"arrowleft":return this.player.currentTime-=5,!0;case"l":case"arrowright":return this.player.currentTime+=5,!0;case"0":return this.player.currentTime=0,!0;case"1":return this.player.currentTime=.1*this.player.duration,!0;case"2":return this.player.currentTime=.2*this.player.duration,!0;case"3":return this.player.currentTime=.3*this.player.duration,!0;case"4":return this.player.currentTime=.4*this.player.duration,!0;case"5":return this.player.currentTime=.5*this.player.duration,!0;case"6":return this.player.currentTime=.6*this.player.duration,!0;case"7":return this.player.currentTime=.7*this.player.duration,!0;case"8":return this.player.currentTime=.8*this.player.duration,!0;case"9":return this.player.currentTime=.9*this.player.duration,!0;case"f":return this.elements.buttons.fullscreen.click(),!0;case"arrowup":try{this.player.volume+=.1}catch{}return!0;case"arrowdown":try{this.player.volume-=.1}catch{}return!0}return!1}inRange(e,t){return e>t.from&&e<t.to}buildSegments(e,t){function s(e,t,s){let l=document.createElement("DIV");return l.classList.add("ltp-progress__segment"),l.style.left=e+"%",l.style.backgroundColor=s,l.style.width=t+"%",l}let l=t[0];for(let n of e){let i=s(n.from,n.to-n.from,n.color);l.background.appendChild(i)}}checkSegments(){if(void 0===this.lastPosition&&(this.lastPosition=0),this.checkingSegments)return;this.checkingSegments=!0;let e=this.player.currentTime/this.player.duration*100;for(let t of this.info.segments)!this.inRange(this.lastPosition,t)&&this.inRange(e,t)&&t.onEnter(this),this.inRange(this.lastPosition,t)&&!this.inRange(e,t)&&t.onExit(this);this.lastPosition=e,this.checkingSegments=!1}showSkipButton(e,t){this.elements.buttons.skip.style.display="block",this.elements.buttons.skip.innerText=e,this.elements.buttons.skip.onclick=()=>{this.player.currentTime=t}}hideSkipButton(){this.elements.buttons.skip.style.display="none"}buildEndscreenElement(e,t){let s=document.createElement("DIV");s.classList.add("ltp-endscreen-item"),s.classList.add("ltp-endscreen-item__"+e.style);let l=document.createElement("IMG"),n=document.createElement("DIV"),i=document.createElement("DIV"),r=document.createElement("DIV");l.classList.add("ltp-endscreen__bg"),n.classList.add("ltp-endscreen-item__text"),i.classList.add("title"),r.classList.add("subtitle"),l.src=e.image[0].url,i.innerText=e.title,r.innerText=e.metadata,s.style.left=100*e.left+"%",s.style.top=100*e.top+"%",s.style.width=100*e.width+"%",s.style.aspectRatio=e.aspectRatio.toString(),s.onclick=()=>{t(e)},n.appendChild(i),n.appendChild(r),s.appendChild(l),s.appendChild(n),this.elements.endscreenContainer.appendChild(s)}buildEndscreen(){this.info.endscreen.items.forEach(e=>{this.buildEndscreenElement(e,this.info.endscreen.onClickHandler)}),this.player.addEventListener("timeupdate",()=>{this.player.currentTime>=this.info.endscreen.startMs&&"none"===this.elements.endscreenContainer.style.display?this.elements.endscreenContainer.style.display="block":this.player.currentTime<=this.info.endscreen.startMs&&"block"===this.elements.endscreenContainer.style.display&&(this.elements.endscreenContainer.style.display="none")})}updateLoading(){let e=this.player.buffered,t=!0;if(0!==e.length)for(let s=0;s<e.length;s++)e.start(s)<=this.player.currentTime&&this.player.currentTime<=e.end(s)-.001&&(t=!1);this.player.currentTime>=this.player.duration-.002&&(t=!1),this.elements.loading.style.display=t?"flex":"none"}}