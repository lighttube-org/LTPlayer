/* LTPlayer v1.0
 * https://github.com/kuylar/LTPlayer
 */
class Player{constructor(e,t){if(this.player=document.querySelector(e),this.player.removeAttribute("controls"),this.info=t,this.playerType="html5",this.controlsHideTime=Number.MAX_SAFE_INTEGER,!t)throw Error("info must be provided while constructing a new PlayerMin instance!");t.chapters&&0!==t.chapters.length||(t.chapters=[{from:0,to:100,name:""}]),t.storyboard&&"yt_l1"===t.storyboard.type&&(this.storyboardImage=new Image,this.storyboardImage.src=t.storyboard.src),this.root=this.buildPlayerElement({author:t.author,title:t.title,playButtonHtml:t.buttons.play,pauseButtonHtml:t.buttons.pause,muteButtonHtml:t.buttons.volumeMedium,settingsButtonHtml:t.buttons.settings,fullscreenButtonHtml:t.buttons.fullscreen,minimizeButtonHtml:t.buttons.minimize,chapters:t.chapters,segments:t.segments,endscreen:t.endscreen}),this.player.parentElement.insertBefore(this.root,this.player),this.root.insertBefore(this.player,this.root.firstElementChild),t.hlsManifest&&Hls.isSupported()&&(this.playerType="hls.js",this.hlsjs=new Hls,this.hlsjs.on(Hls.Events.MANIFEST_PARSED,(e,t)=>{console.log(`[HLS.JS] Manifest parsed with ${t.levels.length} quality levels`),this.updateSelects()}),this.hlsjs.on(Hls.Events.LEVEL_SWITCHED,(e,{level:t})=>{console.log(`[HLS.JS] Switched to the quality level ${this.hlsjs.levels[t].height}p (${t})`),this.updateSelects()}),this.hlsjs.loadSource(t.hlsManifest),this.hlsjs.attachMedia(this.player)),this.assignEvents(),this.updateButtons(),this.updateSelects(),null!=t.endscreen&&this.buildEndscreen()}buildPlayerElement(e){let t=[],s=document.createElement("DIV");s.setAttribute("class","ltp-root");let l=document.createElement("DIV");l.setAttribute("class","ltp-gradient-top"),s.appendChild(l);let n=document.createElement("DIV");n.setAttribute("class","ltp-endscreen"),n.style.display="none",s.appendChild(n);let i=document.createElement("DIV");i.setAttribute("class","ltp-title");let r=document.createElement("A");r.setAttribute("class","ltp-title__icon"),r.setAttribute("style",`background-image: url('${e.author?.icon}');background-size:contain;`),r.setAttribute("href",e.author?.href),r.setAttribute("title",e.author?.title),i.appendChild(r);let a=document.createElement("SPAN");a.setAttribute("class","ltp-title__text"),a.innerHTML=e.title,i.appendChild(a),s.appendChild(i);let o=document.createElement("DIV");o.setAttribute("class","ltp-gradient-bottom"),s.appendChild(o);let h=document.createElement("DIV");for(let p of(h.setAttribute("class","ltp-progress-container"),e.chapters)){let u=document.createElement("DIV");u.setAttribute("class","ltp-progress"),u.setAttribute("title",p.name),u.style.width=p.to-p.from+"%";let d=document.createElement("DIV");d.setAttribute("class","ltp-progress__buffered"),u.appendChild(d);let c=document.createElement("DIV");c.setAttribute("class","ltp-progress__played"),u.appendChild(c),h.appendChild(u),t.push({name:p.name,to:p.to,from:p.from,background:u,buffered:d,played:c})}this.buildSegments(e.segments,t),s.appendChild(h);let m=document.createElement("DIV");m.setAttribute("class","ltp-controls");let y=document.createElement("DIV");y.setAttribute("class","ltp-controls-button"),y.innerHTML=e.playButtonHtml,m.appendChild(y);let b=document.createElement("DIV");b.setAttribute("class","ltp-controls-button"),b.innerHTML=e.pauseButtonHtml,m.appendChild(b);let f=document.createElement("DIV");f.setAttribute("class","ltp-controls-volume-icon");let g;g=this.player.muted?this.info.buttons.volumeMute:this.player.volume>.7?this.info.buttons.volumeHigh:this.player.volume<.3?this.info.buttons.volumeLow:this.info.buttons.volumeMedium,f.innerHTML=g,m.appendChild(f);let E=document.createElement("DIV");E.setAttribute("class","ltp-controls-volume");let $=document.createElement("DIV");$.setAttribute("class","ltp-controls-volume-bar");let k=document.createElement("DIV");k.setAttribute("class","ltp-controls-volume-value"),$.appendChild(k),E.appendChild($),m.appendChild(E);let C=document.createElement("DIV");C.setAttribute("class","ltp-controls-timestamp"),C.innerHTML="--:-- / --:--",m.appendChild(C);let T=document.createElement("DIV");T.setAttribute("class","ltp-controls-divider"),m.appendChild(T);let v=document.createElement("DIV");v.setAttribute("class","ltp-controls-button"),v.innerHTML=e.settingsButtonHtml,m.appendChild(v);let A=document.createElement("DIV");A.setAttribute("class","ltp-controls-button"),A.innerHTML=e.fullscreenButtonHtml,m.appendChild(A);let S=document.createElement("DIV");S.setAttribute("class","ltp-controls-button"),S.innerHTML=e.minimizeButtonHtml,m.appendChild(S),s.appendChild(m);let L=document.createElement("DIV");L.classList.add("ltp-storyboard-container");let M=document.createElement("CANVAS");M.classList.add("ltp-storyboard-image"),L.appendChild(M);let B=document.createElement("DIV");B.classList.add("ltp-storyboard-text"),L.appendChild(B),s.appendChild(L);let I=document.createElement("DIV");I.setAttribute("class","ltp-menu");let _=document.createElement("LABEL");_.setAttribute("class","ltp-menuitem");let x=document.createElement("SPAN");x.innerHTML="Playback speed",_.appendChild(x);let H=document.createElement("SELECT");H.appendChild(this.createMenuOption("0.25",".25")),H.appendChild(this.createMenuOption("0.50",".5")),H.appendChild(this.createMenuOption("0.75",".75")),H.appendChild(this.createMenuOption("Normal","1",!0)),H.appendChild(this.createMenuOption("1.25","1.25")),H.appendChild(this.createMenuOption("1.50","1.5")),H.appendChild(this.createMenuOption("1.75","1.75")),H.appendChild(this.createMenuOption("2","2")),_.appendChild(H),I.appendChild(_);let w=document.createElement("LABEL");w.setAttribute("class","ltp-menuitem");let D=document.createElement("SPAN");D.innerHTML="Subtitles/CC",w.appendChild(D);let V=document.createElement("SELECT");w.appendChild(V),I.appendChild(w);let O=document.createElement("LABEL");O.setAttribute("class","ltp-menuitem");let j=document.createElement("SPAN");j.innerHTML="Quality",O.appendChild(j);let P=document.createElement("SELECT");O.appendChild(P),I.appendChild(O);let N=document.createElement("LABEL");N.setAttribute("class","ltp-menuitem");let q=document.createElement("SPAN");q.innerHTML="Audio track",N.appendChild(q);let F=document.createElement("SELECT");N.appendChild(F),I.appendChild(N),s.appendChild(I);let R=document.createElement("DIV");return R.classList.add("ltp-skip"),s.appendChild(R),O.style.display="none",w.style.display="none",N.style.display="none",I.style.display="none",this.elements={root:s,endscreenContainer:n,authorIcon:r,videoTitle:a,timestamp:C,volumeBar:k,progressBarSections:t,buttons:{play:y,pause:b,mute:f,settings:v,fullscreen:A,minimize:S,skip:R},menus:{menu:I,speed:H,quality:P,subtitles:V,audioTracks:F},storyboard:{container:L,image:M,context:M.getContext("2d"),text:B}},s}createMenuOption(e,t,s){let l=document.createElement("OPTION");return l.innerHTML=e,l.setAttribute("value",t),s&&l.setAttribute("selected","selected"),l}assignEvents(){this.elements.buttons.play.onclick=()=>{this.player.play()},this.elements.buttons.pause.onclick=()=>{this.player.pause()},this.player.onpause=()=>{this.updateButtons()},this.player.onplay=()=>{this.updateButtons()},this.player.onclick=()=>{this.player.paused?this.player.play():this.player.pause()},this.player.ondblclick=()=>{window.fullScreen?document.exitFullscreen().then(()=>{this.updateButtons()}).catch(()=>{this.updateButtons()}):this.root.requestFullscreen({navigationUI:"hide"}).then(()=>{this.updateButtons()}).catch(()=>{this.updateButtons()})},this.player.onmousemove=()=>{this.root.classList.remove("controls-hidden"),this.controlsHideTime=Date.now()+5e3},this.elements.buttons.mute.onclick=()=>{this.player.muted=!this.player.muted,this.updateButtons()},this.elements.buttons.fullscreen.onclick=()=>{this.root.requestFullscreen({navigationUI:"hide"}).then(()=>{this.updateButtons()}).catch(()=>{this.updateButtons()})},this.elements.buttons.minimize.onclick=()=>{document.exitFullscreen().then(()=>{this.updateButtons()}).catch(()=>{this.updateButtons()})},this.player.ontimeupdate=()=>{Date.now()>this.controlsHideTime&&!this.root.classList.contains("controls-hidden")?this.root.classList.add("controls-hidden"):Date.now()<this.controlsHideTime&&this.root.classList.contains("controls-hidden")&&this.root.classList.remove("controls-hidden"),this.resizeProgressBar("played",this.player.currentTime/this.player.duration*100),this.checkSegments()},this.player.onvolumechange=()=>{this.elements.volumeBar.style.width=100*this.player.volume+"%";let e;e=this.player.muted?this.info.buttons.volumeMute:this.player.volume>.7?this.info.buttons.volumeHigh:this.player.volume<.3?this.info.buttons.volumeLow:this.info.buttons.volumeMedium,this.elements.buttons.mute.innerHTML=e},this.elements.volumeBar.parentElement.parentElement.onclick=e=>{this.player.volume=this.percentageFromMouseOverEvent(e,this.elements.volumeBar.parentElement)},this.elements.progressBarSections[0].background.parentElement.onclick=e=>{this.player.currentTime=this.percentageFromMouseOverEvent(e,this.elements.progressBarSections[0].background.parentElement)*this.player.duration},this.elements.progressBarSections[0].background.parentElement.onmousemove=e=>{this.updateStoryboard(this.percentageFromMouseOverEvent(e,this.elements.progressBarSections[0].background.parentElement))},this.elements.progressBarSections[0].background.parentElement.onmouseenter=()=>{this.updateStoryboard(!0)},this.elements.progressBarSections[0].background.parentElement.onmouseleave=()=>{this.updateStoryboard(!1)},this.elements.buttons.settings.onclick=()=>{"none"===this.elements.menus.menu.style.display?this.elements.menus.menu.style.display="flex":this.elements.menus.menu.style.display="none"},this.elements.menus.speed.onchange=()=>{this.player.playbackRate=parseFloat(this.elements.menus.speed.value)},this.elements.menus.quality.onchange=()=>{switch(this.playerType){case"html5":let e=this.player.currentTime;this.player.src=this.elements.menus.quality.value,this.player.currentTime=e;break;case"hls.js":let t=this.elements.menus.quality.value;this.hlsjs.nextLevel=parseInt(t);break;default:console.error(`Unknown player type ${this.playerType}`)}},this.elements.menus.audioTracks.onchange=()=>{"hls.js"===this.playerType?this.hlsjs.audioTrack=parseInt(this.elements.menus.audioTracks.value):console.error(`Unknown player type ${this.playerType}`)},this.elements.menus.subtitles.onchange=()=>{for(let e=0;e<this.player.textTracks.length;e++)this.player.textTracks[e].mode="hidden";if("null"===this.elements.menus.subtitles.value)return;let t=Array.from(this.player.textTracks).filter(e=>e.label===this.elements.menus.subtitles.value)[0];t.mode="showing"},window.onkeydown=e=>{this.elements.root.contains(e.target)&&(e.ctrlKey||e.altKey||e.metaKey||e.shiftKey||this.handleHotkey(e.key))},setInterval(()=>{this.player.buffered.length>0&&this.resizeProgressBar("buffered",this.player.buffered.end(this.player.buffered.length-1)/this.player.duration*100,!0),this.elements.timestamp.innerText=`${this.timestampFromMs(this.player.currentTime)} / ${this.timestampFromMs(this.player.duration)}`},100)}updateButtons(){this.player.paused?(this.elements.buttons.pause.style.display="none",this.elements.buttons.play.style.display="flex"):(this.elements.buttons.play.style.display="none",this.elements.buttons.pause.style.display="flex"),window.fullScreen?(this.elements.buttons.fullscreen.style.display="none",this.elements.buttons.minimize.style.display="flex"):(this.elements.buttons.minimize.style.display="none",this.elements.buttons.fullscreen.style.display="flex")}percentageFromMouseOverEvent(e,t){return t||(t=e.target),this.remapNumber(e.clientX,t.getBoundingClientRect().left,t.getBoundingClientRect().left+t.clientWidth-1,0,1)}timestampFromMs(e){let t=e,s=Math.round(t/3600);t%=3600;let l=Math.round(t/60).toString().padStart(2,"0");return t=Math.round(t%60).toString().padStart(2,"0"),s>0?`${s}:${l}:${t}`:`${l}:${t}`.replaceAll("NaN","--")}resizeProgressBar(e,t){let s=!1;for(let l of this.elements.progressBarSections)s?l[e].style.width="0%":0<=t&&t<=0+l.to?(l[e].style.width=this.remapNumber(t,l.from,l.to,0,100)+"%",s=!0):l[e].style.width="100%"}remapNumber(e,t,s,l,n){return l+(n-l)*(e-t)/(s-t)}updateSelects(){switch(this.playerType){case"html5":let e=Array.from(this.player.children),t=e.filter(e=>"SOURCE"===e.tagName),s=Array.from(this.player.textTracks).filter(e=>"vtt"===e.groupId);if(t.length>1){let l=!1,n=[];for(let i of t){let r=i.getAttribute("label"),a=i.getAttribute("src"),o=a===this.player.currentSrc;o&&(l=!0),n.push(this.createMenuOption(r,a,o))}for(let h of(l||n[0].setAttribute("selected","selected"),n))this.elements.menus.quality.appendChild(h);this.elements.menus.quality.parentElement.style.display="flex"}if(s.length>0){let p=!1,u=[];for(let d of(u.push(this.createMenuOption("Off",null)),s)){let c=d.label,m="showing"===d.mode;m&&(p=!0),u.push(this.createMenuOption(c,c,m))}for(let y of(p||u[0].setAttribute("selected","selected"),u))this.elements.menus.subtitles.appendChild(y);this.elements.menus.subtitles.parentElement.style.display="flex"}break;case"hls.js":let b=[],f=this.hlsjs.levels.filter(e=>e.videoCodec.startsWith("avc1")),g=this.hlsjs.currentLevel>0?this.hlsjs.levels[this.hlsjs.currentLevel].height:void 0,E=[];for(let $ of(this.hlsjs.autoLevelEnabled?E.push(this.createMenuOption(`Auto (${g}p)`,-1,!0)):E.push(this.createMenuOption("Auto",-1)),f))b.includes($.height)||(b.push($.height),E.push(this.createMenuOption($.height+"p",this.hlsjs.levels.indexOf($),$.height===g&&!this.hlsjs.autoLevelEnabled)));for(;this.elements.menus.quality.firstElementChild;)this.elements.menus.quality.children[0].remove();for(let k of E)this.elements.menus.quality.appendChild(k);if(this.elements.menus.quality.parentElement.style.display="flex",this.hlsjs.audioTracks.length>1){let C=[];for(let T of this.hlsjs.audioTracks)C.push(this.createMenuOption(T.name,T.id,this.hlsjs.audioTrack===T.id));for(;this.elements.menus.audioTracks.firstElementChild;)this.elements.menus.audioTracks.children[0].remove();for(let v of C)this.elements.menus.audioTracks.appendChild(v);this.elements.menus.audioTracks.parentElement.style.display="flex"}let A=Array.from(this.player.textTracks).filter(e=>"vtt"===e.groupId);if(console.log(A),A.length>0){let S=!1,L=[];for(let M of(L.push(this.createMenuOption("Off",null)),A)){let B=M.label,I="showing"===M.mode;I&&(S=!0),L.push(this.createMenuOption(B,B,I))}for(S||L[0].setAttribute("selected","selected");this.elements.menus.subtitles.firstElementChild;)this.elements.menus.subtitles.children[0].remove();for(let _ of L)this.elements.menus.subtitles.appendChild(_);this.elements.menus.subtitles.parentElement.style.display="flex"}break;default:console.error(`Unknown player type: ${this.playerType}`)}}updateStoryboard(e){if("boolean"==typeof e)e?this.elements.storyboard.container.style.display="flex":this.elements.storyboard.container.style.display="none";else{let t=e*this.player.duration;this.elements.storyboard.text.innerText=this.timestampFromMs(t),e<.5?(this.elements.storyboard.container.style.left=`calc(${Math.max(0,100*e)}% - 87.5px)`,this.elements.storyboard.container.style.right="unset"):(this.elements.storyboard.container.style.right=`calc(${Math.max(0,(1-e)*100)}% - 87.5px)`,this.elements.storyboard.container.style.left="unset"),null==this.storyboardImage?this.elements.storyboard.image.style.display="none":this.elements.storyboard.context.drawImage(this.storyboardImage,48*Math.floor((10*e-Math.trunc(10*e))*10),27*Math.floor(10*e),48,27,0,0,this.elements.storyboard.image.width,this.elements.storyboard.image.height)}}handleHotkey(e){switch(e.toLowerCase()){case" ":case"k":this.player.paused?this.player.play():this.player.pause();break;case"m":this.elements.buttons.mute.click();break;case"j":case"arrowleft":this.player.currentTime-=5;break;case"l":case"arrowright":this.player.currentTime+=5;break;case"0":this.player.currentTime=0;break;case"1":this.player.currentTime=.1*this.player.duration;break;case"2":this.player.currentTime=.2*this.player.duration;break;case"3":this.player.currentTime=.3*this.player.duration;break;case"4":this.player.currentTime=.4*this.player.duration;break;case"5":this.player.currentTime=.5*this.player.duration;break;case"6":this.player.currentTime=.6*this.player.duration;break;case"7":this.player.currentTime=.7*this.player.duration;break;case"8":this.player.currentTime=.8*this.player.duration;break;case"9":this.player.currentTime=.9*this.player.duration;break;case"f":null!=document.fullscreenElement?this.elements.buttons.minimize.click():this.elements.buttons.fullscreen.click()}}inRange(e,t){return e>t.from&&e<t.to}buildSegments(e,t){function s(e,t,s){let l=document.createElement("DIV");return l.classList.add("ltp-progress__segment"),l.style.left=e+"%",l.style.backgroundColor=s,l.style.width=t+"%",l}let l=t[0];for(let n of e){let i=s(n.from,n.to-n.from,n.color);l.background.appendChild(i)}}checkSegments(){if(void 0===this.lastPosition&&(this.lastPosition=0),this.checkingSegments)return;this.checkingSegments=!0;let e=this.player.currentTime/this.player.duration*100;for(let t of this.info.segments)!this.inRange(this.lastPosition,t)&&this.inRange(e,t)&&t.onEnter(this),this.inRange(this.lastPosition,t)&&!this.inRange(e,t)&&t.onExit(this);this.lastPosition=e,this.checkingSegments=!1}showSkipButton(e,t){this.elements.buttons.skip.style.display="block",this.elements.buttons.skip.innerText=e,this.elements.buttons.skip.onclick=()=>{this.player.currentTime=t}}hideSkipButton(){this.elements.buttons.skip.style.display="none"}buildEndscreenElement(e,t){let s=document.createElement("DIV");s.classList.add("ltp-endscreen-item"),s.classList.add("ltp-endscreen-item__"+e.style);let l=document.createElement("IMG"),n=document.createElement("DIV"),i=document.createElement("DIV"),r=document.createElement("DIV");l.classList.add("ltp-endscreen__bg"),n.classList.add("ltp-endscreen-item__text"),i.classList.add("title"),r.classList.add("subtitle"),l.src=e.image[0].url,i.innerText=e.title,r.innerText=e.metadata,s.style.left=100*e.left+"%",s.style.top=100*e.top+"%",s.style.width=100*e.width+"%",s.style.aspectRatio=e.aspectRatio.toString(),s.onclick=()=>{t(e)},n.appendChild(i),n.appendChild(r),s.appendChild(l),s.appendChild(n),this.elements.endscreenContainer.appendChild(s)}buildEndscreen(){this.info.endscreen.items.forEach(e=>{this.buildEndscreenElement(e,this.info.endscreen.onClickHandler)}),this.player.addEventListener("timeupdate",()=>{this.player.currentTime>=this.info.endscreen.startMs&&"none"===this.elements.endscreenContainer.style.display?this.elements.endscreenContainer.style.display="block":this.player.currentTime<=this.info.endscreen.startMs&&"block"==this.elements.endscreenContainer.style.display&&(this.elements.endscreenContainer.style.display="none")})}}